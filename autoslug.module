<?php

use Drupal\Core\Entity\EntityInterface;

function autoslug_entity_insert(EntityInterface $entity) {
  autoslug_create_entity_alias($entity);
}

function autoslug_create_entity_alias(EntityInterface $entity) {
  $langcode = $entity->language()->getId();
  $config = Drupal::service('autoslug.config')->configForEntity($entity, $langcode);

  if ($config) {
    $aliases = Drupal::service('path.alias_storage');
    $cache_key = '/' . $entity->urlInfo()->getInternalPath();

    if (!$url = $aliases->lookupPathAlias($cache_key, $langcode)) {
      if (!empty($config['path'])) {
        $pattern = $config['path'];
        $slugs = Drupal::service('autoslug.alias_generator');
        $alias = $slugs->aliasByPattern($entity, $pattern);
        $aliases->save($cache_key, $alias, $langcode);
      }
    }
  }
}

function autoslug_generate_entity_aliases() {
  $counter = 0;
  $em = Drupal::entityManager();
  // $node_storage = $em->getStorage('node');
  //
  //
  // foreach ($node_storage->loadMultiple(null) as $node) {
  //   autoslug_create_entity_alias($node);
  //
  //   if ($counter++ % 10 == 9) {
  //     var_dump('node ' . $counter);
  //     flush();
  //   }
  // }

  $terms = $em->getStorage('taxonomy_term')->loadByProperties([
    'vid' => 'asklib_municipalities'
  ]);

  foreach ($terms as $term) {
    autoslug_create_entity_alias($term);

    if ($counter++ % 10 == 9) {
      var_dump('term ' . $counter);
      flush();
    }
  }
}

function autoslug_preprocess() {
  static $i = 0;

  if (!$i++ && isset($_GET['create_aliases'])) {
    autoslug_generate_entity_aliases();
  }
}
